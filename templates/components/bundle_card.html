<!-- Bundle Card -->
{% load static %}
<div class="glass-card rounded-lg overflow-hidden" data-bundle-id="{{ bundle.id }}">
  <div class="relative h-64 bg-gray-800">
    <img src="{{ bundle.image.url }}" alt="{{ bundle.title }}" class="w-full h-full object-cover" />
    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 to-transparent"></div>
    <div class="absolute bottom-4 left-4">
      <span class="bg-primary text-white text-sm px-3 py-1 rounded-full font-medium">{{ bundle.beat_count }} Beats</span>
      <span class="bg-gray-800/80 text-white text-sm px-3 py-1 rounded-full font-medium ml-2">Save {{ bundle.discount }}%</span>
    </div>
  </div>
  <div class="p-5">
    <div class="flex justify-between items-start mb-4">
      <h3 class="text-xl font-semibold text-white">{{ bundle.title }}</h3>
      <div class="text-right">
        <span class="text-gray-400 line-through text-sm">${{ bundle.original_price }}</span>
        <span class="text-primary font-bold text-xl ml-2">${{ bundle.discounted_price }}</span>
      </div>
    </div>
    <p class="text-gray-400 mb-5">{{ bundle.description }}</p>
    <div class="flex items-center justify-between">
      <button onclick="showBundlePreview({{ bundle.id }})" class="bg-transparent border border-white/30 hover:border-white/50 text-white px-4 py-2 rounded-button text-sm font-medium transition-colors flex items-center gap-2 whitespace-nowrap">
        <i class="ri-play-circle-line"></i>
        Preview Bundle
      </button>
      <button onclick="handleAddBundleToCart({{ bundle.id }}, '{{ bundle.title }}')" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-button text-sm font-medium transition-colors whitespace-nowrap">
        Add to Cart
      </button>
    </div>
  </div>
</div>

<script>
function handleAddBundleToCart(bundleId, bundleTitle) {
  fetch(`/add-to-cart/bundle/${bundleId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    },
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.status === 'success') {
      showNotification(data.message, 'success');
      // Fetch actual cart count from server
      return fetch('/cart/').then(response => response.json());
    } else {
      showNotification(data.message || 'Error adding bundle to cart', 'error');
      throw new Error('Failed to add bundle');
    }
  })
  .then(cartData => {
    // Update cart badge with actual count
    const cartBadge = document.querySelector('#cartButton span');
    if (cartBadge) {
      cartBadge.textContent = cartData.items.length;
      cartBadge.classList.remove('hidden');
    }
  })
  .catch(error => {
    if (error.message !== 'Failed to add bundle') {
      showNotification('Error adding bundle to cart', 'error');
    }
  });
}

// Function to update cart count
function updateCartCount() {
  fetch('/cart/')
    .then(response => response.json())
    .then(data => {
      const cartCount = data.items.length;
      // Update all cart count elements (in case there are multiple instances)
      const cartCountElements = document.querySelectorAll('[data-cart-count]');
      cartCountElements.forEach(element => {
        element.textContent = cartCount;
        if (cartCount > 0) {
          element.classList.remove('hidden');
        } else {
          element.classList.add('hidden');
        }
      });
      
      // Also update any elements with id 'cartCount' for backward compatibility
      const cartCountElement = document.getElementById('cartCount');
      if (cartCountElement) {
        cartCountElement.textContent = cartCount;
        if (cartCount > 0) {
          cartCountElement.classList.remove('hidden');
        } else {
          cartCountElement.classList.add('hidden');
        }
      }
    })
    .catch(error => {
      console.error('Error updating cart count:', error);
    });
}

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script> 